<svelte:options immutable /><script>import katex from 'katex';
import { tick } from 'svelte';
import { clickoutside } from '@svelte-put/clickoutside';
import Hovering from './Hovering.svelte';
import { getContainerContext } from '../components/Slate.svelte';
export let open = false;
export let title = 'LaTeX Editor';
export let math = '';
export let inline = true;
export let isNew = true;
export let onDone;
const containerContext = getContainerContext();
$: container = $containerContext;
let openedAt = Date.now();
let prevOpen = open;
$: if (prevOpen !== open) {
    openedAt = Date.now();
    prevOpen = open;
}
function onDoneInternal() {
    open = false;
    onDone(math, inline);
}
function onInlineChange() {
    inline = !inline;
}
function onClickOutside() {
    if (openedAt + 100 < Date.now()) {
        open = false;
    }
}
let textareaElement;
let mathDisplayElement;
$: if (open && mathDisplayElement) {
    katex.render(math, mathDisplayElement, {
        displayMode: !inline,
        output: 'html',
        throwOnError: false
    });
}
$: if (open && textareaElement) {
    tick().then(() => {
        textareaElement.focus();
    });
}
</script><Hovering {container} bind:open><div class="math-editor-body" use:clickoutside on:clickoutside={onClickOutside}><div class="math-editor-title">{title}</div><div class="math-editor-content"><div class="math-editor-math"><div class="math-editor-latexinput"><textarea bind:this={textareaElement} bind:value={math} /></div><div class="math-editor-buttons"><button type="button" class:active={!math} on:click={onDoneInternal}>{#if isNew}Insert{:else}Update{/if}</button><button type="button" class:active={!inline} on:click={onInlineChange}>{#if inline}Block{:else}Inline{/if}</button></div><div class="math-editor-rendering"><span bind:this={mathDisplayElement} /></div></div></div></div></Hovering><style>
	.math-editor-title {
		margin: 4px 0px;
	}
	.math-editor-body {
		border: 1px solid black;
		padding: 0.25rem;
		display: block;
		background-color: white;
	}
	.math-editor-latexinput textarea {
		border: 1px solid #333;
		padding: 0.25rem;
		min-height: 110px;
	}
	.math-editor-rendering {
		border: 1px solid #333;
		padding: 0.5rem;
	}
	.math-editor-math span {
		padding: 0.25rem;
	}
	textarea {
		border: none;
		border-bottom: 1px solid black;
		padding: 0;
		min-width: 384px;
		min-height: 64px;
		outline: none;
	}
	button {
		cursor: pointer;
		border: 1px solid black;
		padding: 0 6px;
		margin: 0.25rem;
		height: 1.5rem;
		background-color: white;
	}
	button.active {
		opacity: 0.8;
	}</style>
